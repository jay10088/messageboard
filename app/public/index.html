<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>留言板</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .container {
        text-align: center;
      }
      .title {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .login {
        margin-top: 15px;
        margin-left: 50px;
      }
      .box {
        width: 600px;
        height: 500px;
        border: 1px solid black;
        font-size: 20px;
        margin: 20px auto;
        text-align: left;
      }
      .bar {
        width: 450px;
        height: 30px;
        border: 1px solid black;
      }
      #textContent {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }  
      button {
        height: 20px;
        margin-left: 20px;
      }
      .rules {
        width: 300px;
        height: 500px;
        border: 1px solid gray;
        margin-left: 20px;
        padding: 10px;
        font-size: 16px;
      }
      li {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>

    <div class = "container">
      <div class = "title">
        <h1>留言板</h1>
        <a href = "login.html" target = "_self" class = "login">登入</a>
        <a href = "#" id = "btnLogout" class = "login">登出</a>
        <a href = "register.html" target = "_self" class = "login">註冊</a>
      </div>

      <div id = "board" class = "box">
        <ul id = "list"></ul>
      </div>

      <div id = "textContent">
        <input id = "content" class = "bar" type = "text" placeholder = "輸入留言(上限40字)" />
        <button onclick = "create()">新增留言</button>
      </div>
    </div>

    <div class="rules">
      <h3>留言規則</h3>
      <ul>
        <li>要留言須先登入</li>
        <li>留言上限為20字</li>
        <li>留言需花費點數，每次需耗費1點</li>
        <li>註冊可得5點，儲值可獲得更多點數</li>
      </ul>
      <button onclick="addPoint()">儲值點數</button>
    </div>

    <script>
      //開啟頁面時加載資料
      document.addEventListener("DOMContentLoaded", async () => {
        await load();
      })

      // 讀取清單 + 刪除按鈕 + 更新按鈕
      async function load() {
        const res = await fetch('/api/message');
        const sqlData = await res.json();

        const list = document.getElementById('list');
        list.innerHTML = '';

        sqlData.forEach(m => {
          const li = document.createElement('li');
          const text = document.createElement('span');
          text.textContent = `${ m.username } say: ${ m.content }`;
          
          // 更新按鈕
          const btnUpd = document.createElement('button');
          btnUpd.textContent = '更新';
          btnUpd.addEventListener('click' , async () => {
            const content = prompt("請輸入更新內容");

            if (content) {
              const r = await fetch('/api/message/' + encodeURIComponent(m.id), {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify( { content:content } ),
              });
              const data = await r.json();
              alert(data.msg);
            }

            load();
          });

          // 刪除按鈕
          const btnDel = document.createElement('button');
          btnDel.textContent = '刪除';
          btnDel.addEventListener('click', async () => {
            let shouldDelete = confirm("確定要刪除嗎");   
                   
            if (shouldDelete) {
              const r = await fetch('/api/message/' + encodeURIComponent(m.id), {
                method: 'DELETE'
              });
              const data = await r.json();
              alert(data.msg);
            }

            load();
          });

          li.appendChild(text);
          li.appendChild(btnUpd);
          li.appendChild(btnDel);
          list.appendChild(li);
        });
      }

      // 新增資料
      async function create() {
        const row = document.getElementById('content');
        const content = row.value.trim();

        const r = await fetch('/api/message/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify( { content } )
        });

        const contentData = await r.json();
        alert(contentData.msg);
        row.value = '';

        load();
      }

      async function logout(e) {
        e.preventDefault();

        const r = await fetch('/api/logout', {
          method: 'POST',
          credentials: 'same-origin'
        });
        const data = await r.json();

        alert(data.msg);
      }
      document.getElementById('btnLogout').addEventListener('click', logout);

      async function addPoint() {
        const r = await fetch('/api/loginInfo');
        data = await r.json();
        if (r.ok) {
          window.location.href = "point.html";
        } else {
          alert(data.msg);
        }
      }
    </script>
  </body>
</html>
